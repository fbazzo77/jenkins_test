pipeline {
    agent any
    
    parameters {
        // Uso 'output' invece di 'ouput'
        string(name: 'pathToDirI', defaultValue: '/orfeo/scratch/area/fbazzocchi/test_jen/input', description: 'input file dir')
        string(name: 'pathToDirO', defaultValue: '/orfeo/scratch/area/fbazzocchi/test_jen/output', description: 'output file dir')
    }
    
    environment {
        // CORREZIONE: Uso 'params' invece di 'parameters' (sebbene tu lo avessi già fatto correttamente)
        // Correzione 2: Uso ${params.pathToDirI}, il valore viene risolto in environment
        INPUT_DIR = "${params.pathToDirI}" 
        OUTPUT_DIR = "${params.pathToDirO}"
    }
    
    stages {
        stage('Pull project repository on the Cluster and Run Script') {
            steps {
                // withCredentials è il blocco corretto per gestire le chiavi SSH
                withCredentials([sshUserPrivateKey(credentialsId: 'orfeo_jenkins_onpexp', keyFileVariable: 'SSH_ONPEXP_KEY', passphraseVariable: '', usernameVariable: 'SSH_ONPEXP_USER')]) {
                    
                    // Nota: Ho usato le doppie virgolette (") e le escape sequence (\') per la stringa del comando SSH,
                    // in modo da poter usare le variabili Jenkins (es. ${env.INPUT_DIR}) all'interno del comando sh Groovy.
                    sh "ssh -i ${SSH_ONPEXP_KEY} ${SSH_ONPEXP_USER}@10.128.2.80 ' \
                            cd /orfeo/scratch/area/fbazzocchi/test_jen && git pull; \
                            cd /orfeo/scratch/area/fbazzocchi/test_jen/jenkins_test; \
                            \
                            # Esegue lo script Python con i parametri passati dalla pipeline \
                            python3 test_script.py ${env.INPUT_DIR} ${env.OUTPUT_DIR} \
                        '"
                } // 
            }
        } // 
    } // 
} // 
